function MainMenu(menu,visibleItemsNumber){var self=this,container=menu.children(".container"),main=container.children(".main"),mainItems=main.children(),mainLinks=mainItems.find(".menu-lvl0-link"),btnShow=$("#catalog-show"),btnHide=$("#catalog-hide"),btnSwitch=$("#catalog-switch"),adds=$('<div class="catalog-menu-lvl0 additional" />'),addsItems,addsLinks,state,prevState,containerH=container.outerHeight(),containerW=container.outerWidth(),visible=$.isNumeric(visibleItemsNumber)?visibleItemsNumber:7,stateChanged,visibleChanged,opened=!1,timeout,rebuildTimeout,resizeTimeout;function resizeHandler(){self.switched()&&self.rebuild()}this.resetHandlers=function(){$(document).off("click.mainMenu resize.mainMenu"),menu.off("click.menuMobile click.mainMenu mouseenter.mainMenu mouseleave.mainMenu hitstoggle"),btnSwitch.off("click.mainMenu")},this.resetFull=function(){container.removeClass("ready btn-shown"),main.css("display",""),adds&&adds.detach().css("display",""),addsItems&&addsItems.length>0&&(mainItems=mainItems.add(addsItems),mainLinks=mainLinks.add(addsLinks),main.append(addsItems)),mainItems.css("width",""),mainLinks.css("height",""),self.resetHandlers()},this.setHandlersNotMobile=function(){menu.on("mouseenter.mainMenu",".catalog-menu-lvl0-item",function(){var _=$(this),submenu=_.children(".submenu-wrap");_.hasClass("opened")?submenu.velocity("stop").velocity("reverse"):(submenu.addClass("opened"),isTouch&&!isMobile&&"yes"===b2.s.catalogDarken&&(submenu.parent().find(".menu-lvl0-link").addClass("hovered"),submenu.closest(".catalog-at-top, .catalog-at-side").hasClass("darken-popup")||submenu.closest(".catalog-at-top, .catalog-at-side").addClass("darken-popup")),setTimeout(function(){"function"==typeof initHCarousel&&submenu.find(".scroll-slider-wrap").each(initHCarousel)},50))}).on("mouseleave.mainMenu",".catalog-menu-lvl0-item",function(){var _,submenu=$(this).children(".submenu-wrap");submenu.removeClass("opened"),isTouch&&!isMobile&&"yes"===b2.s.catalogDarken&&(submenu.closest(".catalog-at-top, .catalog-at-side").removeClass("darken-popup"),submenu.parent().find(".menu-lvl0-link").removeClass("hovered"))}).on("hitstoggle",function(e,data){"show"===data.type&&"function"==typeof initHCarousel&&data.wrap.each(initHCarousel)}),isHover&&"yes"===b2.s.catalogDarken&&menu.on("mouseenter.mainMenu",".catalog-menu-lvl0-item .submenu-wrap",function(){var _=$(this);_.parent().find(".menu-lvl0-link").addClass("hovered"),_.closest(".catalog-at-top, .catalog-at-side").hasClass("darken-popup")||_.closest(".catalog-at-top, .catalog-at-side").addClass("darken-popup")}).on("mouseleave.mainMenu",".catalog-menu-lvl0-item .submenu-wrap",function(){var _=$(this);_.closest(".catalog-at-top, .catalog-at-side").removeClass("darken-popup"),_.parent().find(".menu-lvl0-link").removeClass("hovered")})},this.setMinHandlers=function(){btnSwitch.on("click.mainMenu",function(e){e.stopPropagation(),opened?(main.velocity("slideUp",0,"linear"),$(this).removeClass("opened"),opened=!1):(main.velocity("slideDown",0,"linear"),$(this).addClass("opened"),opened=!0)})},this.makeTouch=function(){menu.on("click",".menu-lvl0-link",function(e){e.preventDefault()})},this.makeMobile=function(){container.addClass("ready btn-shown"),menu.on("click.menuMobile",".menu-lvl0-link",function(e){var _=$(this),submenu;return 0===(submenu=_.hasClass("with-addit-link")?_.parent().siblings(".submenu-wrap"):_.siblings(".submenu-wrap")).length||(_.closest(".container").find(".expanded").not(submenu).velocity("slideUp","fast","linear").removeClass("expanded"),submenu.hasClass("expanded")?submenu.velocity("slideUp","fast","linear").removeClass("expanded"):submenu.velocity("slideDown","fast","linear").addClass("expanded"),!1)}).on("click.menuMobile",".menu-lvl1-link",function(e){var submenu=$(this).closest(".menu-lvl1-header").siblings("ul");return 0===submenu.length||(submenu.closest(".submenu-wrap").find(".expanded").not(submenu).velocity("slideUp","fast","linear").removeClass("expanded"),submenu.hasClass("expanded")?submenu.velocity("slideUp","fast","linear").removeClass("expanded"):submenu.velocity("slideDown","fast","linear").addClass("expanded"),!1)})},this.makeSideMin=function(){0===menu.closest(".catalog-aside").length?$(document).on("click.mainMenu",function(e){opened&&0===$(e.target).closest(".catalog-menu").length&&(main.velocity("slideUp",300,"linear"),btnSwitch.removeClass("opened"),opened=!1)}):(btnSwitch.addClass("opened"),opened=!0,main.css("display","block"),$(document).off("click.mainMenu")),container.addClass("ready btn-shown")},this.makeSideFull=function(){var limit=container.closest("#catalog-at-side").outerHeight();if(container.outerHeight()>limit){for(var i=mainItems.length-1;i>=0;i--)if(mainItems.eq(i).position().top+40<=limit&&i<=visible){addsItems=mainItems.slice(i),addsLinks=mainLinks.slice(i),mainItems=mainItems.slice(0,i),mainLinks=mainLinks.slice(0,i),adds.prepend(addsItems).appendTo(container);break}container.addClass("ready btn-shown")}else container.addClass("ready")},this.makeTop=function(){var limit=container.width(),btnW=0;if(main.outerWidth()>limit||mainItems.length>visible){container.addClass("btn-shown"),btnW=btnShow.outerWidth(),limit=container.width()-btnW;for(var i=mainItems.length-1;i>=0;i--)if(mainItems.eq(i).position().left<=limit&&i<=visible){addsItems=mainItems.slice(i),addsLinks=mainLinks.slice(i),mainItems=mainItems.slice(0,i),mainLinks=mainLinks.slice(0,i),adds.prepend(addsItems).appendTo(container);break}}mainItems.css("width",100/mainItems.length+"%");var maxH=main.outerHeight();mainLinks.css("height",maxH),container.addClass("ready"),$(document).on("click.mainMenu",function(e){menu.hasClass("opened")&&0===$(e.target).closest(".catalog-menu-lvl0.additional, #btn-catalog-wrap").length&&menu.removeClass("opened")})},this.switched=function(){return Modernizr.mq("(max-width: 767px)")?"mobile"!==state&&(prevState=state,state="mobile",!0):"mobile"===state?prevState?(state=prevState,prevState="mobile","side minified"===state&&menu.closest(".catalog-page").length>0&&(Modernizr.mq("(max-width: 991px)")?$("#catalog-at-side").prependTo(".breadcrumbs"):$("#catalog-at-side").prependTo(".catalog-aside")),!0):(self.updateState(),!1):"side full"===state?changed=containerH!==container.outerHeight():"top"===state?changed=containerW!==container.outerWidth():("side minified"===state&&menu.closest(".catalog-page").length>0&&(Modernizr.mq("(max-width: 991px)")?$("#catalog-at-side").prependTo(".breadcrumbs"):$("#catalog-at-side").prependTo(".catalog-aside"),self.makeSideMin()),!1);var changed,changed},this.updateState=function(){if(Modernizr.mq("(max-width: 767px)")){if("mobile"===state)return;prevState=state,state="mobile"}else menu.closest(".catalog-at-top").length>0&&"top"!==state?(prevState=state,state="top"):menu.closest(".catalog-at-side.full").length>0&&"side full"!==state?(prevState=state,state="side full"):menu.closest(".catalog-at-side.minified").length>0&&"side minified"!==state&&(prevState=state,state="side minified",menu.closest(".catalog-page").length>0&&(Modernizr.mq("(max-width: 991px)")?$("#catalog-at-side").prependTo(".breadcrumbs"):$("#catalog-at-side").prependTo(".catalog-aside")));self.rebuild(visible)},this.updateVisible=function(number){visible!==number&&$.isNumeric(number)&&(visible=number,"top"===state&&self.rebuild())},this.rebuild=function(){clearTimeout(rebuildTimeout),rebuildTimeout=setTimeout(function(){switch(state){case"mobile":"side minified"!==prevState?self.resetFull():self.resetHandlers(),clearTimeout(timeout),timeout=setTimeout(function(){self.makeMobile(),self.setMinHandlers()},10);break;case"side minified":"mobile"!==prevState?self.resetFull():self.resetHandlers(),clearTimeout(timeout),timeout=setTimeout(function(){self.makeSideMin(),self.setHandlersNotMobile(),self.setMinHandlers(),!isMobile&&isTouch&&self.makeTouch()},10);break;case"side full":self.resetFull(),clearTimeout(timeout),timeout=setTimeout(function(){self.makeSideFull(),self.setHandlersNotMobile(),menu.on("click.mainMenu","#catalog-show",function(e){e.stopPropagation(),adds.velocity("slideDown",0,"linear"),menu.addClass("opened")}).on("click.mainMenu","#catalog-hide",function(e){e.stopPropagation(),adds.velocity("slideUp",0,"linear"),menu.removeClass("opened")}),!isMobile&&isTouch&&self.makeTouch(),containerH=container.outerHeight()},10);break;case"top":self.resetFull(),clearTimeout(timeout),timeout=setTimeout(function(){self.makeTop(),self.setHandlersNotMobile(),!isMobile&&isTouch&&self.makeTouch(),containerW=container.outerWidth()},10);break;default:console.log("Smth wrong with mainMenu.update")}stateChanged=!1,visibleChanged=!1},10)},$(window).on("resize.mainMenu",function(){clearTimeout(resizeTimeout),resizeTimeout=setTimeout(resizeHandler,150)})}