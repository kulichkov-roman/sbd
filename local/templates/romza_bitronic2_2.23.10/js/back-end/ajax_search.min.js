function JCRZB2TitleSearch(arParams){var _this=this;this.arParams={AJAX_PAGE:arParams.AJAX_PAGE,CONTAINER_ID:arParams.CONTAINER_ID,RESULT_ID:arParams.RESULT_ID,INPUT_ID:arParams.INPUT_ID,MIN_QUERY_LEN:parseInt(arParams.MIN_QUERY_LEN)},arParams.WAIT_IMAGE&&(this.arParams.WAIT_IMAGE=arParams.WAIT_IMAGE),arParams.MIN_QUERY_LEN<=0&&(arParams.MIN_QUERY_LEN=1),this.cache=[],this.cache_key=null,this.startText="",this.currentRow=-1,this.RESULT=null,this.CONTAINER=null,this.INPUT=null,this.WAIT=null,this.ShowResult=function(result){null!=result&&(_this.RESULT.innerHTML=result),_this.RESULT.innerHTML.length>0?_this.RESULT.style.display="block":_this.RESULT.style.display="none",RZB2.ajax.BasketSmall.RefreshButtons()},this.onKeyPress=function(keyCode){var tbl=BX.findChild(_this.RESULT,{tag:"table",class:"title-search-result"},!0);if(!tbl)return!1;var cnt=tbl.rows.length;switch(keyCode){case 27:return _this.RESULT.style.display="none",_this.currentRow=-1,_this.UnSelectAll(),!0;case 40:"none"==_this.RESULT.style.display&&(_this.RESULT.style.display="block");for(var first=-1,i=0;i<cnt;i++)if(!BX.findChild(tbl.rows[i],{class:"title-search-separator"},!0)){if(-1==first&&(first=i),_this.currentRow<i){_this.currentRow=i;break}"title-search-selected"==tbl.rows[i].className&&(tbl.rows[i].className="")}return i==cnt&&_this.currentRow!=i&&(_this.currentRow=first),tbl.rows[_this.currentRow].className="title-search-selected",!0;case 38:"none"==_this.RESULT.style.display&&(_this.RESULT.style.display="block");for(var last=-1,i=cnt-1;i>=0;i--)if(!BX.findChild(tbl.rows[i],{class:"title-search-separator"},!0)){if(-1==last&&(last=i),_this.currentRow>i){_this.currentRow=i;break}"title-search-selected"==tbl.rows[i].className&&(tbl.rows[i].className="")}return i<0&&_this.currentRow!=i&&(_this.currentRow=last),tbl.rows[_this.currentRow].className="title-search-selected",!0;case 13:if("block"==_this.RESULT.style.display)for(var i=0;i<cnt;i++)if(_this.currentRow==i&&!BX.findChild(tbl.rows[i],{class:"title-search-separator"},!0)){var a=BX.findChild(tbl.rows[i],{tag:"a"},!0);if(a)return window.location=a.href,!0}return!1}return!1},this.onTimeout=function(){_this.onChange(function(){setTimeout(_this.onTimeout,500)})},this.onChange=function(callback){if(_this.INPUT.value!=_this.oldValue&&_this.INPUT.value!=_this.startText)if(_this.oldValue=_this.INPUT.value,_this.INPUT.value.length>=_this.arParams.MIN_QUERY_LEN){if(_this.cache_key=_this.arParams.INPUT_ID+"|"+_this.INPUT.value,null==_this.cache[_this.cache_key]){if(_this.WAIT){var pos=BX.pos(_this.INPUT),height=pos.bottom-pos.top-2;_this.WAIT.style.top=pos.top+1+"px",_this.WAIT.style.height=height+"px",_this.WAIT.style.width=height+"px",_this.WAIT.style.left=pos.right-height+2+"px",_this.WAIT.style.display="block"}if(void 0===_this.spinner){var $button=$(_this.CONTAINER).find(".btn-search");$button.find("i").hide(),_this.spinner=RZB2.ajax.spinner($button),_this.spinner.Start()}return void BX.ajax.post(_this.arParams.AJAX_PAGE,{ajax_call:"y",INPUT_ID:_this.arParams.INPUT_ID,q:_this.INPUT.value,l:_this.arParams.MIN_QUERY_LEN},function(result){_this.cache[_this.cache_key]=result,_this.ShowResult(result),_this.currentRow=-1,_this.EnableMouseEvents(),_this.WAIT&&(_this.WAIT.style.display="none"),callback&&callback(),"object"==typeof _this.spinner&&(_this.spinner.Stop(),_this.spinner=void 0,$button.find("i").show())})}_this.ShowResult(_this.cache[_this.cache_key]),_this.currentRow=-1,_this.EnableMouseEvents()}else _this.RESULT.style.display="none",_this.currentRow=-1,_this.UnSelectAll();callback&&callback()},this.UnSelectAll=function(){var tbl=BX.findChild(_this.RESULT,{tag:"table",class:"title-search-result"},!0);if(tbl)for(var cnt=tbl.rows.length,i=0;i<cnt;i++)tbl.rows[i].className=""},this.EnableMouseEvents=function(){var tbl=BX.findChild(_this.RESULT,{tag:"table",class:"title-search-result"},!0);if(tbl)for(var cnt=tbl.rows.length,i=0;i<cnt;i++)BX.findChild(tbl.rows[i],{class:"title-search-separator"},!0)||(tbl.rows[i].id="row_"+i,tbl.rows[i].onmouseover=function(e){_this.currentRow!=this.id.substr(4)&&(_this.UnSelectAll(),this.className="title-search-selected",_this.currentRow=this.id.substr(4))},tbl.rows[i].onmouseout=function(e){this.className="",_this.currentRow=-1})},this.onFocusLost=function(hide){setTimeout(function(){_this.RESULT.style.display="none"},250)},this.onFocusGain=function(){_this.RESULT.innerHTML.length&&_this.ShowResult()},this.onKeyDown=function(e){if(e||(e=window.event),"block"==_this.RESULT.style.display&&_this.onKeyPress(e.keyCode))return BX.PreventDefault(e)},this.Init=function(){this.CONTAINER=document.getElementById(this.arParams.CONTAINER_ID),this.RESULT=document.getElementById(this.arParams.RESULT_ID),this.INPUT=document.getElementById(this.arParams.INPUT_ID),this.startText=this.oldValue=this.INPUT.value;var clearBtn=$(this.CONTAINER).find(".search-clear");BX.bind(this.INPUT,"focus",function(){_this.onFocusGain()}),BX.browser.IsSafari()||BX.browser.IsIE()?this.INPUT.onkeydown=this.onKeyDown:this.INPUT.onkeypress=this.onKeyDown,this.arParams.WAIT_IMAGE&&(this.WAIT=document.body.appendChild(document.createElement("DIV")),this.WAIT.style.backgroundImage="url('"+this.arParams.WAIT_IMAGE+"')",BX.browser.IsIE()||(this.WAIT.style.backgroundRepeat="none"),this.WAIT.style.display="none",this.WAIT.style.position="absolute",this.WAIT.style.zIndex="1100"),BX.bind(this.INPUT,"bxchange",function(){_this.onChange()}),$(this.INPUT).on("change",function(){_this.onChange()}),clearBtn.on("click",function(){_this.ShowResult("")})},BX.ready(function(){_this.Init(arParams)})}